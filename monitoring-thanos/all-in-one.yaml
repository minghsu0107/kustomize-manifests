---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
- apiGroups: [""]
  resources:
  - nodes
  - nodes/proxy
  - services
  - endpoints
  - pods
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources:
  - configmaps
  verbs: ["get"]
- nonResourceURLs: ["/metrics"]
  verbs: ["get"]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-k8s
---
apiVersion: v1
data:
  default.tmpl: |
    {{ define "__alertmanager" }}AlertManager{{ end }}
    {{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }}

    {{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}
    {{ define "__description" }}{{ end }}

    {{ define "__text_alert_list" }}{{ range . }}Labels:
    {{ range .Labels.SortedPairs }} - {{ .Name }} = {{ .Value }}
    {{ end }}Annotations:
    {{ range .Annotations.SortedPairs }} - {{ .Name }} = {{ .Value }}
    {{ end }}Source: {{ .GeneratorURL }}
    {{ end }}{{ end }}


    {{ define "slack.default.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "slack.default.username" }}{{ template "__alertmanager" . }}{{ end }}
    {{ define "slack.default.fallback" }}{{ template "slack.default.title" . }} | {{ template "slack.default.titlelink" . }}{{ end }}
    {{ define "slack.default.pretext" }}{{ end }}
    {{ define "slack.default.titlelink" }}{{ template "__alertmanagerURL" . }}{{ end }}
    {{ define "slack.default.iconemoji" }}{{ end }}
    {{ define "slack.default.iconurl" }}{{ end }}
    {{ define "slack.default.text" }}{{ end }}


    {{ define "hipchat.default.from" }}{{ template "__alertmanager" . }}{{ end }}
    {{ define "hipchat.default.message" }}{{ template "__subject" . }}{{ end }}


    {{ define "pagerduty.default.description" }}{{ template "__subject" . }}{{ end }}
    {{ define "pagerduty.default.client" }}{{ template "__alertmanager" . }}{{ end }}
    {{ define "pagerduty.default.clientURL" }}{{ template "__alertmanagerURL" . }}{{ end }}
    {{ define "pagerduty.default.instances" }}{{ template "__text_alert_list" . }}{{ end }}


    {{ define "opsgenie.default.message" }}{{ template "__subject" . }}{{ end }}
    {{ define "opsgenie.default.description" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}
    {{ if gt (len .Alerts.Firing) 0 -}}
    Alerts Firing:
    {{ template "__text_alert_list" .Alerts.Firing }}
    {{- end }}
    {{ if gt (len .Alerts.Resolved) 0 -}}
    Alerts Resolved:
    {{ template "__text_alert_list" .Alerts.Resolved }}
    {{- end }}
    {{- end }}
    {{ define "opsgenie.default.source" }}{{ template "__alertmanagerURL" . }}{{ end }}


    {{ define "victorops.default.message" }}{{ template "__subject" . }} | {{ template "__alertmanagerURL" . }}{{ end }}
    {{ define "victorops.default.from" }}{{ template "__alertmanager" . }}{{ end }}


    {{ define "email.default.subject" }}{{ template "__subject" . }}{{ end }}
    {{ define "email.default.html" }}
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    <!--
    Style and HTML derived from https://github.com/mailgun/transactional-email-templates


    The MIT License (MIT)

    Copyright (c) 2014 Mailgun

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
    -->
    <html xmlns="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/xhtml" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
    <head style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
    <meta name="viewport" content="width=device-width" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
    <title style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">{{ template "__subject" . }}</title>

    </head>

    <body itemscope="" itemtype="http://schema.org/EmailMessage" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; -webkit-font-smoothing: antialiased; -webkit-text-size-adjust: none; height: 100%; line-height: 1.6em; width: 100% !important; background-color: #f6f6f6; margin: 0; padding: 0;" bgcolor="#f6f6f6">

    <table style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; background-color: #f6f6f6; margin: 0;" bgcolor="#f6f6f6">
      <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
        <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0;" valign="top"></td>
        <td width="600" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; display: block !important; max-width: 600px !important; clear: both !important; width: 100% !important; margin: 0 auto; padding: 0;" valign="top">
          <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; max-width: 600px; display: block; margin: 0 auto; padding: 0;">
            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; border-radius: 3px; background-color: #fff; margin: 0; border: 1px solid #e9e9e9;" bgcolor="#fff">
              <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 16px; vertical-align: top; color: #fff; font-weight: 500; text-align: center; border-radius: 3px 3px 0 0; background-color: #E6522C; margin: 0; padding: 20px;" align="center" bgcolor="#E6522C" valign="top">
                  {{ .Alerts | len }} alert{{ if gt (len .Alerts) 1 }}s{{ end }} for {{ range .GroupLabels.SortedPairs }}
                    {{ .Name }}={{ .Value }}
                  {{ end }}
                </td>
              </tr>
              <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 10px;" valign="top">
                  <table width="100%" cellpadding="0" cellspacing="0" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                    <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                      <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">
                        <a href="{{ template "__alertmanagerURL" . }}" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #FFF; text-decoration: none; line-height: 2em; font-weight: bold; text-align: center; cursor: pointer; display: inline-block; border-radius: 5px; text-transform: capitalize; background-color: #348eda; margin: 0; border-color: #348eda; border-style: solid; border-width: 10px 20px;">View in {{ template "__alertmanager" . }}</a>
                      </td>
                    </tr>
                    {{ if gt (len .Alerts.Firing) 0 }}
                    <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                      <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">
                        <strong style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">[{{ .Alerts.Firing | len }}] Firing</strong>
                      </td>
                    </tr>
                    {{ end }}
                    {{ range .Alerts.Firing }}
                    <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                      <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">
                        <strong style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">Labels</strong><br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
                        {{ range .Labels.SortedPairs }}{{ .Name }} = {{ .Value }}<br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}
                        {{ if gt (len .Annotations) 0 }}<strong style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">Annotations</strong><br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}
                        {{ range .Annotations.SortedPairs }}{{ .Name }} = {{ .Value }}<br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}
                        <a href="{{ .GeneratorURL }}" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #348eda; text-decoration: underline; margin: 0;">Source</a><br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
                      </td>
                    </tr>
                    {{ end }}

                    {{ if gt (len .Alerts.Resolved) 0 }}
                      {{ if gt (len .Alerts.Firing) 0 }}
                    <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                      <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">
                        <br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
                        <hr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
                        <br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
                      </td>
                    </tr>
                      {{ end }}
                    <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                      <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">
                        <strong style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">[{{ .Alerts.Resolved | len }}] Resolved</strong>
                      </td>
                    </tr>
                    {{ end }}
                    {{ range .Alerts.Resolved }}
                    <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                      <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">
                        <strong style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">Labels</strong><br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
                        {{ range .Labels.SortedPairs }}{{ .Name }} = {{ .Value }}<br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}
                        {{ if gt (len .Annotations) 0 }}<strong style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">Annotations</strong><br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}
                        {{ range .Annotations.SortedPairs }}{{ .Name }} = {{ .Value }}<br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}
                        <a href="{{ .GeneratorURL }}" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #348eda; text-decoration: underline; margin: 0;">Source</a><br style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />
                      </td>
                    </tr>
                    {{ end }}
                  </table>
                </td>
              </tr>
            </table>

            <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; clear: both; color: #999; margin: 0; padding: 20px;">
              <table width="100%" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                <tr style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">
                  <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 12px; vertical-align: top; text-align: center; color: #999; margin: 0; padding: 0 0 20px;" align="center" valign="top"><a href="{{ .ExternalURL }}" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 12px; color: #999; text-decoration: underline; margin: 0;">Sent by {{ template "__alertmanager" . }}</a></td>
                </tr>
              </table>
            </div></div>
        </td>
        <td style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0;" valign="top"></td>
      </tr>
    </table>

    </body>
    </html>

    {{ end }}

    {{ define "pushover.default.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "pushover.default.message" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}
    {{ if gt (len .Alerts.Firing) 0 }}
    Alerts Firing:
    {{ template "__text_alert_list" .Alerts.Firing }}
    {{ end }}
    {{ if gt (len .Alerts.Resolved) 0 }}
    Alerts Resolved:
    {{ template "__text_alert_list" .Alerts.Resolved }}
    {{ end }}
    {{ end }}
    {{ define "pushover.default.url" }}{{ template "__alertmanagerURL" . }}{{ end }}
  slack.tmpl: |
    {{ define "slack.devops.text" }}
    {{range .Alerts}}{{.Annotations.DESCRIPTION}}
    {{end}}
    {{ end }}
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: alertmanager-templates
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: alertmanager
data:
  config.yml: |-
    global:
      # ResolveTimeout is the time after which an alert is declared resolved
      # if it has not been updated.
      resolve_timeout: 5m

      # The smarthost and SMTP sender used for mail notifications.
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'foo@bar.com'
      smtp_auth_username: 'foo@bar.com'
      smtp_auth_password: 'barfoo'

      # The API URL to use for Slack notifications.
      slack_api_url: 'https://hooks.slack.com/services/your-webhook'

    # # The directory from which notification templates are read.
    templates:
    - '/etc/alertmanager-templates/*.tmpl'

    # The root route on which each incoming alert enters.
    route:

      # The labels by which incoming alerts are grouped together. For example,
      # multiple alerts coming in for cluster=A and alertname=LatencyHigh would
      # be batched into a single group.

      group_by: ['alertname', 'cluster', 'service']

      # When a new group of alerts is created by an incoming alert, wait at
      # least 'group_wait' to send the initial notification.
      # This way ensures that you get multiple alerts for the same group that start
      # firing shortly after another are batched together on the first
      # notification.

      group_wait: 30s

      # When the first notification was sent, wait 'group_interval' to send a batch
      # of new alerts that started firing for that group.

      group_interval: 5m

      # If an alert has successfully been sent, wait 'repeat_interval' to
      # resend them.

      #repeat_interval: 1m
      repeat_interval: 15m

      # A default receiver

      # If an alert isn't caught by a route, send it to default.
      receiver: default

      # All the above attributes are inherited by all child routes and can
      # overwritten on each.

      # The child route trees.
      routes:
      # Send severity=slack alerts to slack.
      - match:
          severity: slack
        receiver: slack_alert
      # - match:
      #     severity: email
      #   receiver: email_alert

    receivers:
    - name: 'default'
      slack_configs:
      - channel: '#alert-test'
        text: '<!channel>{{ template "slack.devops.text" . }}'
        send_resolved: true

    - name: 'slack_alert'
      slack_configs:
      - channel: '#alert-test'
        send_resolved: true
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      name: alertmanager
      labels:
        app: alertmanager
    spec:
      containers:
      - name: alertmanager
        image: prom/alertmanager:v0.21.0
        args:
          - '--config.file=/etc/alertmanager/config.yml'
          - '--storage.path=/alertmanager'
        ports:
        - name: alertmanager
          containerPort: 9093
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 200m
            memory: 256Mi
        volumeMounts:
        - name: config-volume
          mountPath: /etc/alertmanager
        - name: templates-volume
          mountPath: /etc/alertmanager-templates
        - name: alertmanager
          mountPath: /alertmanager
      volumes:
      - name: config-volume
        configMap:
          name: alertmanager
      - name: templates-volume
        configMap:
          name: alertmanager-templates
      - name: alertmanager
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/scrape: 'true'
    prometheus.io/path: '/metrics'
  labels:
    name: alertmanager
  name: alertmanager
spec:
  selector:
    app: alertmanager
  type: NodePort
  ports:
  - name: alertmanager
    protocol: TCP
    port: 9093
    nodePort: 30615
    targetPort: 9093
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana-core
  labels:
    app: grafana
    app.kubernetes.io/component: core
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
        app.kubernetes.io/component: core
    spec:
      containers:
      - image: grafana/grafana:7.3.5
        name: grafana-core
        imagePullPolicy: IfNotPresent
        # env:
        resources:
          # keep request = limit to keep this container in guaranteed class
          limits:
            cpu: 100m
            memory: 100Mi
          requests:
            cpu: 100m
            memory: 100Mi
        env:
          # The following env variables set up basic auth twith the default admin user and admin password.
          - name: GF_AUTH_BASIC_ENABLED
            value: "true"
          - name: GF_SECURITY_ADMIN_USER
            valueFrom:
              secretKeyRef:
                name: grafana
                key: admin-username
          - name: GF_SECURITY_ADMIN_PASSWORD
            valueFrom:
              secretKeyRef:
                name: grafana
                key: admin-password
          - name: GF_AUTH_ANONYMOUS_ENABLED
            value: "false"
        readinessProbe:
          httpGet:
            path: /login
            port: 3000
          # initialDelaySeconds: 30
          # timeoutSeconds: 1
        volumeMounts:
        - name: grafana-persistent-storage
          mountPath: /var/lib/grafana
      volumes:
      - name: grafana-persistent-storage
        persistentVolumeClaim:
          claimName: grafana-data
      initContainers:
        - name: fix-permissions
          image: busybox
          # Grafana needs a user that has 472 user ID
          command: ["sh", "-c", "chown -R 472:472 /var/lib/grafana"]
          securityContext:
            privileged: true
          volumeMounts:
          - name: grafana-persistent-storage
            mountPath: /var/lib/grafana
---
apiVersion: v1
kind: Secret
data:
  # admin
  admin-password: YWRtaW4=
  admin-username: YWRtaW4=
metadata:
  name: grafana
type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  labels:
    app: grafana
    app.kubernetes.io/component: core
spec:
  type: NodePort
  ports:
    - port: 3000
      nodePort: 31565
  selector:
    app: grafana
    app.kubernetes.io/component: core
---
apiVersion: v1
data:
  prometheus.yaml: |
    global:
      scrape_interval: 10s
      scrape_timeout: 10s
      evaluation_interval: 10s
      external_labels:
        cluster: prometheus-ha
    rule_files:
      - "/etc/prometheus-rules/*rules.yaml"
    alerting:
      alertmanagers:
      - scheme: http
        path_prefix: /
        static_configs:
        - targets:
          - "alertmanager:9093"
    scrape_configs:
      - job_name: 'kubernetes-nodes'
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - source_labels: [__address__]
            regex: '(.*):10250'
            replacement: '${1}:10255'
            target_label: __address__
    
      - job_name: 'kubernetes-endpoints'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
            action: replace
            target_label: __scheme__
            regex: (https?)
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: (.+)(?::\d+);(\d+)
            replacement: $1:$2
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: kubernetes_name

      - job_name: 'kubernetes-cadvisor'
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor

      - job_name: kubernetes-node-exporter
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
        - source_labels: [__address__]
          regex: ^(.*):\d+$
          target_label: __address__
          replacement: $1:9100
        - target_label: __scheme__
          replacement: http
        # Host name
        - source_labels: [__meta_kubernetes_node_name]
          target_label: instance
        # Extract some labels
        - source_labels: [__meta_kubernetes_node_label_failure_domain_beta_kubernetes_io_zone]
          target_label: zone
        - source_labels: [__meta_kubernetes_node_label_cloud_google_com_gke_nodepool]
          target_label: gke_nodepool

kind: ConfigMap
metadata:
  creationTimestamp: null
  name: prometheus-core
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: prometheus-core
  labels:
    app: prometheus
    thanos: sidecar
    app.kubernetes.io/component: core
spec:
  serviceName: thanos-store-gateway
  replicas: 2
  selector:
    matchLabels:
      app: prometheus
      thanos: sidecar
      app.kubernetes.io/component: core
  template:
    metadata:
      name: prometheus-main
      labels:
        app: prometheus
        thanos: sidecar
        app.kubernetes.io/component: core
        thanos-store-api: "true"
    spec:
      serviceAccountName: prometheus-k8s
      containers:
      - name: prometheus
        image: prom/prometheus:v2.25.2
        args:
          - "--storage.tsdb.path=/prometheus/data"
          - "--storage.tsdb.retention.time=3d"
          - "--storage.tsdb.min-block-duration=2h"
          - "--storage.tsdb.max-block-duration=2h"
          # - "--storage.tsdb.no-lockfile"
          - "--web.enable-lifecycle"
          - '--config.file=/etc/prometheus/prometheus.yaml'
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        ports:
        - name: webui
          containerPort: 9090
        volumeMounts:
        - name: config-volume
          mountPath: /etc/prometheus
        - name: rules-volume
          mountPath: /etc/prometheus-rules
        - name: prometheus-data
          mountPath: /prometheus/data
        - name: prometheus-config-shared
          mountPath: /etc/prometheus-shared
      - name: thanos
        image: thanosio/thanos:main-2021-04-15-2a999d25
        args:
          - "sidecar"
          - |
            --objstore.config=type: S3
            config:
              bucket: prometheus-long-term
              endpoint: minio-hl-svc.minio:9000
              access_key: "$(AWS_ACCESS_KEY_ID)"
              secret_key: "$(AWS_SECRET_KEY)"
              insecure: true
          - "--log.level=debug"
          - "--tsdb.path=/prometheus/data"
          - "--prometheus.url=http://127.0.0.1:9090"
          - "--reloader.rule-dir=/etc/prometheus-rules/"
          - "--reloader.config-file=/etc/prometheus/prometheus.yaml"
          - "--reloader.config-envsubst-file=/etc/prometheus-shared/prometheus.yaml"
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: s3-secret
                key: accesskey
          - name: AWS_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: s3-secret
                key: secretkey
        ports:
          - name: http-sidecar
            containerPort: 10902
          - name: grpc
            containerPort: 10901
        livenessProbe:
            httpGet:
              port: 10902
              path: /-/healthy
        readinessProbe:
          httpGet:
            port: 10902
            path: /-/ready
        volumeMounts:
          - name: config-volume
            mountPath: /etc/prometheus
          - name: rules-volume
            mountPath: /etc/prometheus-rules
          - name: prometheus-data
            mountPath: /prometheus/data
          - name: prometheus-config-shared
            mountPath: /etc/prometheus-shared
      volumes:
      - name: config-volume
        configMap:
          name: prometheus-core
      - name: prometheus-config-shared
        emptyDir: {}
      - name: rules-volume
        configMap:
          name: prometheus-rules
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-state-metrics
  labels:
    app: kube-state-metrics
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kube-state-metrics
  template:
    metadata:
      labels:
        app: kube-state-metrics
    spec:
      serviceAccountName: kube-state-metrics
      containers:
      - name: kube-state-metrics
        image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.0.0-rc.0
        ports:
        - containerPort: 8080
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-state-metrics
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-state-metrics
subjects:
- kind: ServiceAccount
  name: kube-state-metrics
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-state-metrics
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  - secrets
  - nodes
  - pods
  - services
  - resourcequotas
  - replicationcontrollers
  - limitranges
  - persistentvolumeclaims
  - persistentvolumes
  - namespaces
  - endpoints
  verbs:
  - list
  - watch
- apiGroups:
  - extensions
  resources:
  - daemonsets
  - deployments
  - replicasets
  - ingresses
  verbs:
  - list
  - watch
- apiGroups:
  - apps
  resources:
  - statefulsets
  - daemonsets
  - deployments
  - replicasets
  verbs:
  - list
  - watch
- apiGroups:
  - batch
  resources:
  - cronjobs
  - jobs
  verbs:
  - list
  - watch
- apiGroups:
  - autoscaling
  resources:
  - horizontalpodautoscalers
  verbs:
  - list
  - watch
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
- apiGroups:
  - policy
  resources:
  - poddisruptionbudgets
  verbs:
  - list
  - watch
- apiGroups:
  - certificates.k8s.io
  resources:
  - certificatesigningrequests
  verbs:
  - list
  - watch
- apiGroups:
  - storage.k8s.io
  resources:
  - storageclasses
  verbs:
  - list
  - watch
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - mutatingwebhookconfigurations
  - validatingwebhookconfigurations
  verbs:
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - networkpolicies
  verbs:
  - list
  - watch
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - list
  - watch
- apiGroups:
  - storage.k8s.io
  resources:
  - volumeattachments
  verbs:
  - list
  - watch
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-state-metrics
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/scrape: 'true'
  name: kube-state-metrics
  labels:
    app: kube-state-metrics
spec:
  ports:
  - name: kube-state-metrics
    port: 8080
    protocol: TCP
  selector:
    app: kube-state-metrics

---
# This DaemonSet provides metrics in Prometheus format about disk usage on the nodes.
# The container read-du reads in sizes of all directories below /mnt and writes that to /tmp/metrics. It only reports directories larger then 100M for now.
# The other container `caddy` just hands out the contents of that file on request via http/ on /metrics at port 9102 which are the defaults for Prometheus.
# These are scheduled on every node in the Kubernetes cluster.
# To choose directories from the node to check, just mount them on the read-du container below /mnt.
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-directory-size-metrics
  labels:
    app: node-directory-size-metrics
  annotations:
    prometheus.io/scrape: 'true'
    prometheus.io/port: '9102'
spec:
  selector:
    matchLabels:
      app: node-directory-size-metrics
  template:
    metadata:
      labels:
        app: node-directory-size-metrics
    spec:
      # This Pod provides metrics in Prometheus format about disk usage on the node.
      # The container read-du reads in sizes of all directories below /mnt and writes that to /tmp/metrics. It only reports directories larger then 100M for now.
      # The other container caddy just hands out the contents of that file on request on /metrics at port 9102 which are the defaults for Prometheus.
      # This `Pod` is scheduled on every node in the Kubernetes cluster.
      # To choose directories from the node to check just mount them on read-du below /mnt.
      containers:
      - name: read-du
        image: giantswarm/tiny-tools
        imagePullPolicy: Always
        # FIXME threshold via env var
        # The
        command:
        - fish
        - --command
        - |
          touch /tmp/metrics-temp
          while true
            for directory in (du --bytes --separate-dirs --threshold=100M /mnt)
              echo $directory | read size path
              echo "node_directory_size_bytes{path=\"$path\"} $size" \
                >> /tmp/metrics-temp
            end
            mv /tmp/metrics-temp /tmp/metrics
            sleep 300
          end
        volumeMounts:
        - name: host-fs-var
          mountPath: /mnt/var
          readOnly: true
        - name: metrics
          mountPath: /tmp
      - name: caddy
        image: dockermuenster/caddy:0.9.3
        command:
        - "caddy"
        - "-port=9102"
        - "-root=/var/www"
        ports:
        - containerPort: 9102
        volumeMounts:
        - name: metrics
          mountPath: /var/www
      volumes:
      - name: host-fs-var
        hostPath:
          path: /var
      - name: metrics
        emptyDir:
          medium: Memory
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: prometheus-node-exporter
  labels:
    app: prometheus
    app.kubernetes.io/component: node-exporter
spec:
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      name: prometheus-node-exporter
      labels:
        app: prometheus
        app.kubernetes.io/component: node-exporter
    spec:
      containers:
      - image: prom/node-exporter:v1.0.1
        name: prometheus-node-exporter
        ports:
        - name: prom-node-exp
          #^ must be an IANA_SVC_NAME (at most 15 characters, ..)
          containerPort: 9100
          hostPort: 9100
      hostNetwork: true
      hostPID: true
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/scrape: 'true'
  name: prometheus-node-exporter
  labels:
    app: prometheus
    app.kubernetes.io/component: node-exporter
spec:
  clusterIP: None
  ports:
    - name: prometheus-node-exporter
      port: 9100
      protocol: TCP
  selector:
    app: prometheus
    app.kubernetes.io/component: node-exporter
  type: ClusterIP
---
apiVersion: v1
data:
  alert-rules.yaml: |-
    groups:
    - name: Nodes
      rules:
      - alert: HighCPUUsage
        annotations:
          summary: "{{$labels.instance}}: High CPU usage detected"
          description: "{{$labels.instance}}: CPU usage is above 75% (current value is: {{ $value }})"
        expr: |
          (100 - (avg by (instance) (irate(node_cpu_seconds_total{app_kubernetes_io_component="node-exporter",mode="idle"}[5m])) * 100)) > 75
        for: 2m
        labels:
          severity: page
      - alert: NodeLowRootDisk
        annotations:
          summary: "{{$labels.instance}}: Low root disk space"
          description: "{{$labels.instance}}: Root disk usage is above 75% (current value is: {{ $value }})"
        expr: |
          ((node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_free_bytes{mountpoint="/"} ) / node_filesystem_size_bytes{mountpoint="/"} * 100) > 75
        for: 2m
        labels:
          severity: page
      - alert: NodeSwapUsage
        annotations:
          summary: "{{$labels.instance}}: Swap usage detected"
          description: "{{$labels.instance}}: Swap usage usage is above 75% (current value is: {{ $value }})"
        expr: |
          (((node_memory_SwapTotal_bytes-node_memory_SwapFree_bytes)/node_memory_SwapTotal_bytes)*100) > 75
        for: 2m
        labels:
          severity: page
      - alert: HighMemoryUsage
        annotations:
          summary: "{{$labels.instance}}: High memory usage detected"
          description: "{{$labels.instance}}: Memory usage is above 75% (current value is: {{ $value }})"
        expr: |
          (((node_memory_MemTotal_bytes-node_memory_MemAvailable_bytes)/(node_memory_MemTotal_bytes)*100)) > 75
        for: 2m
        labels:
          severity: page
    - name: Pods
      rules:
      - alert: Container restarted
        annotations:
          summary: Container named {{$labels.container}} in {{$labels.pod}} in {{$labels.namespace}} was restarted
        expr: |
          sum(increase(kube_pod_container_status_restarts_total{namespace!="kube-system"}[1m])) by (pod,namespace,container) > 0
        for: 0m
        labels:
          severity: warn
      - alert: High Memory Usage of Container 
        annotations: 
          summary: Container named {{$labels.container}} in {{$labels.pod}} in {{$labels.namespace}} is using more than 75% of Memory Limit
        expr: | 
          (((sum(container_memory_usage_bytes{image!="", namespace!="kube-system"}) by (namespace,container,pod)  / sum(container_spec_memory_limit_bytes{image!="", namespace!="kube-system"}) by (namespace,container,pod)) * 100) < +Inf) > 75
        for: 5m
        labels:
          severity: warn
      - alert: High CPU Usage of Container 
        annotations: 
          summary: Container named {{$labels.container}} in {{$labels.pod}} in {{$labels.namespace}} is using more than 75% of CPU Limit
        expr: | 
          ((sum(irate(container_cpu_usage_seconds_total{image!="", namespace!="kube-system"}[5m])) by (namespace,container,pod) / sum(container_spec_cpu_quota{image!="", namespace!="kube-system"} / container_spec_cpu_period{image!="",namespace!="kube-system"}) by (namespace,container,pod) ) * 100) > 75
        for: 5m
        labels:
          severity: warn
    - name: Instance
      rules:
      - alert: InstanceDown
        annotations:
          summary: "Instance {{ $labels.instance }} down"
          description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minute."
        expr: |
          up == 0
        for: 1m
        labels:
          severity: page
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: prometheus-rules
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thanos-querier
  labels:
    app: thanos-querier
spec:
  replicas: 4
  selector:
    matchLabels:
      app: thanos-querier
  template:
    metadata:
      labels:
        app: thanos-querier
    spec:
      containers:
      - name: thanos
        image: thanosio/thanos:main-2021-04-15-2a999d25
        args:
        - query
        - --log.level=debug
        - --query.replica-label=replica
        - --store=dnssrv+thanos-store-gateway:10901
        ports:
        - name: http
          containerPort: 10902
        - name: grpc
          containerPort: 10901
        livenessProbe:
          httpGet:
            port: http
            path: /-/healthy
        readinessProbe:
          httpGet:
            port: http
            path: /-/ready
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: thanos-store-gateway
  labels:
    app: thanos-store-gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      app: thanos-store-gateway
  serviceName: thanos-store-gateway
  template:
    metadata:
      labels:
        app: thanos-store-gateway
        thanos-store-api: "true"
    spec:
      containers:
        - name: thanos
          image: thanosio/thanos:main-2021-04-15-2a999d25
          args:
          - "store"
          - "--log.level=debug"
          - "--data-dir=/data"
          - |
            --objstore.config=type: S3
            config:
              bucket: prometheus-long-term
              endpoint: minio-hl-svc.minio:9000
              access_key: "$(AWS_ACCESS_KEY_ID)"
              secret_key: "$(AWS_SECRET_KEY)"
              insecure: true
          - "--index-cache-size=500MB"
          - "--chunk-pool-size=500MB"
          env:
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: s3-secret
                key: accesskey
          - name: AWS_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: s3-secret
                key: secretkey
          ports:
          - name: http
            containerPort: 10902
          - name: grpc
            containerPort: 10901
          livenessProbe:
            httpGet:
              port: 10902
              path: /-/healthy
          readinessProbe:
            httpGet:
              port: 10902
              path: /-/ready
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: thanos-compactor
  labels:
    app: thanos-compactor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: thanos-compactor
  serviceName: thanos-compactor
  template:
    metadata:
      labels:
        app: thanos-compactor
    spec:
      containers:
      - name: thanos
        image: thanosio/thanos:main-2021-04-15-2a999d25
        args:
          - "compact"
          - "--log.level=debug"
          - "--data-dir=/tmp/thanos-compact"
          - |
            --objstore.config=type: S3
            config:
              bucket: prometheus-long-term
              endpoint: minio-hl-svc.minio:9000
              access_key: "$(AWS_ACCESS_KEY_ID)"
              secret_key: "$(AWS_SECRET_KEY)"
              insecure: true
          - "--wait"
          - "--wait-interval=5m"
        env:
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: s3-secret
                key: accesskey
          - name: AWS_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: s3-secret
                key: secretkey
        ports:
          - name: http
            containerPort: 10902
        livenessProbe:
          httpGet:
            port: 10902
            path: /-/healthy
        readinessProbe:
          httpGet:
            port: 10902
            path: /-/ready
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: thanos-ruler-rules
  namespace: monitoring
data:
  alert_down_services.rules.yaml: |
    groups:
    - name: thanos-compact
      rules:
      - alert: ThanosCompactMultipleRunning
        annotations:
          description: No more than one Thanos Compact instance should be running at once.
            There are {{$value}} instances running.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanoscompactmultiplerunning
          summary: Thanos Compact has multiple instances running.
        expr: sum by (app) (up{app="thanos-compactor"}) > 1
        for: 5m
        labels:
          severity: warning
      - alert: ThanosCompactHalted
        annotations:
          description: Thanos Compact {{$labels.instance}} has failed to run and now is halted.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanoscompacthalted
          summary: Thanos Compact has failed to run ans is now halted.
        expr: thanos_compact_halted{} == 1
        for: 5m
        labels:
          severity: warning
      - alert: ThanosCompactHighCompactionFailures
        annotations:
          description: Thanos Compact {{$labels.instance}} is failing to execute {{$value | humanize}}%
            of compactions.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanoscompacthighcompactionfailures
          summary: Thanos Compact is failing to execute compactions.
        expr: |
          (
            sum by (app) (rate(thanos_compact_group_compactions_failures_total{}[5m]))
          /
            sum by (app) (rate(thanos_compact_group_compactions_total{}[5m]))
          * 100 > 5
          )
        for: 15m
        labels:
          severity: warning
      - alert: ThanosCompactBucketHighOperationFailures
        annotations:
          description: Thanos Compact {{$labels.instance}} Bucket is failing to execute {{$value
            | humanize}}% of operations.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanoscompactbuckethighoperationfailures
          summary: Thanos Compact Bucket is having a high number of operation failures.
        expr: |
          (
            sum by (app) (rate(thanos_objstore_bucket_operation_failures_total{}[5m]))
          /
            sum by (app) (rate(thanos_objstore_bucket_operations_total{}[5m]))
          * 100 > 5
          )
        for: 15m
        labels:
          severity: warning
      - alert: ThanosCompactHasNotRun
        annotations:
          description: Thanos Compact {{$labels.instance}} has not uploaded anything for 24 hours.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanoscompacthasnotrun
          summary: Thanos Compact has not uploaded anything for last 24 hours.
        expr: (time() - max by (job) (max_over_time(thanos_objstore_bucket_last_successful_upload_time{app="thanos-compactor"}[24h])))
          / 60 / 60 > 24
        labels:
          severity: warning
    - name: thanos-rule
      rules:
      - alert: ThanosRuleQueueIsDroppingAlerts
        annotations:
          description: Thanos Rule {{$labels.instance}} is failing to queue alerts.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosrulequeueisdroppingalerts
          summary: Thanos Rule is failing to queue alerts.
        expr: |
          sum by (app, instance) (rate(thanos_alert_queue_alerts_dropped_total{app="thanos-ruler"}[5m])) > 0
        for: 5m
        labels:
          severity: critical
      - alert: ThanosRuleSenderIsFailingAlerts
        annotations:
          description: Thanos Rule {{$labels.instance}} is failing to send alerts to alertmanager.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosrulesenderisfailingalerts
          summary: Thanos Rule is failing to send alerts to alertmanager.
        expr: |
          sum by (app, instance) (rate(thanos_alert_sender_alerts_dropped_total{app="thanos-ruler"}[5m])) > 0
        for: 5m
        labels:
          severity: critical
      - alert: ThanosRuleHighRuleEvaluationFailures
        annotations:
          description: Thanos Rule {{$labels.instance}} is failing to evaluate rules.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosrulehighruleevaluationfailures
          summary: Thanos Rule is failing to evaluate rules.
        expr: |
          (
            sum by (app, instance) (rate(prometheus_rule_evaluation_failures_total{app="thanos-ruler"}[5m]))
          /
            sum by (app, instance) (rate(prometheus_rule_evaluations_total{app="thanos-ruler"}[5m]))
          * 100 > 5
          )
        for: 5m
        labels:
          severity: critical
      - alert: ThanosRuleHighRuleEvaluationWarnings
        annotations:
          description: Thanos Rule {{$labels.instance}} has high number of evaluation warnings.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosrulehighruleevaluationwarnings
          summary: Thanos Rule has high number of evaluation warnings.
        expr: |
          sum by (app, instance) (rate(thanos_rule_evaluation_with_warnings_total{app="thanos-ruler"}[5m])) > 0
        for: 15m
        labels:
          severity: info
      - alert: ThanosRuleRuleEvaluationLatencyHigh
        annotations:
          description: Thanos Rule {{$labels.instance}} has higher evaluation latency than
            interval for {{$labels.rule_group}}.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosruleruleevaluationlatencyhigh
          summary: Thanos Rule has high rule evaluation latency.
        expr: |
          (
            sum by (app, instance, rule_group) (prometheus_rule_group_last_duration_seconds{app="thanos-ruler"})
          >
            sum by (app, instance, rule_group) (prometheus_rule_group_interval_seconds{app="thanos-ruler"})
          )
        for: 5m
        labels:
          severity: warning
      - alert: ThanosRuleGrpcErrorRate
        annotations:
          description: Thanos Rule {{$labels.instance}} is failing to handle {{$value | humanize}}%
            of requests.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosrulegrpcerrorrate
          summary: Thanos Rule is failing to handle grpc requests.
        expr: |
          (
            sum by (app, instance) (rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss|DeadlineExceeded", app="thanos-ruler"}[5m]))
          /
            sum by (app, instance) (rate(grpc_server_started_total{app="thanos-ruler"}[5m]))
          * 100 > 5
          )
        for: 5m
        labels:
          severity: warning
      - alert: ThanosRuleConfigReloadFailure
        annotations:
          description: Thanos Rule {{$labels.instance}} has not been able to reload its configuration.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosruleconfigreloadfailure
          summary: Thanos Rule has not been able to reload configuration.
        expr: avg by (app, instance) (thanos_rule_config_last_reload_successful{app="thanos-ruler"})
          != 1
        for: 5m
        labels:
          severity: info
      - alert: ThanosRuleQueryHighDNSFailures
        annotations:
          description: Thanos Rule {{$labels.instance}} has {{$value | humanize}}% of failing
            DNS queries for query endpoints.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosrulequeryhighdnsfailures
          summary: Thanos Rule is having high number of DNS failures.
        expr: |
          (
            sum by (app, instance) (rate(thanos_rule_query_apis_dns_failures_total{app="thanos-ruler"}[5m]))
          /
            sum by (app, instance) (rate(thanos_rule_query_apis_dns_lookups_total{app="thanos-ruler"}[5m]))
          * 100 > 1
          )
        for: 15m
        labels:
          severity: warning
      - alert: ThanosRuleAlertmanagerHighDNSFailures
        annotations:
          description: Thanos Rule {{$labels.instance}} has {{$value | humanize}}% of failing
            DNS queries for Alertmanager endpoints.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosrulealertmanagerhighdnsfailures
          summary: Thanos Rule is having high number of DNS failures.
        expr: |
          (
            sum by (app, instance) (rate(thanos_rule_alertmanagers_dns_failures_total{app="thanos-ruler"}[5m]))
          /
            sum by (app, instance) (rate(thanos_rule_alertmanagers_dns_lookups_total{app="thanos-ruler"}[5m]))
          * 100 > 1
          )
        for: 15m
        labels:
          severity: warning
      - alert: ThanosRuleNoEvaluationFor10Intervals
        annotations:
          description: Thanos Rule {{$labels.instance}} has {{$value | humanize}}% rule groups
            that did not evaluate for at least 10x of their expected interval.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosrulenoevaluationfor10intervals
          summary: Thanos Rule has rule groups that did not evaluate for 10 intervals.
        expr: |
          time() -  max by (app, instance, group) (prometheus_rule_group_last_evaluation_timestamp_seconds{app="thanos-ruler"})
          >
          10 * max by (app, instance, group) (prometheus_rule_group_interval_seconds{app="thanos-ruler"})
        for: 5m
        labels:
          severity: info
      - alert: ThanosNoRuleEvaluations
        annotations:
          description: Thanos Rule {{$labels.instance}} did not perform any rule evaluations
            in the past 10 minutes.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosnoruleevaluations
          summary: Thanos Rule did not perform any rule evaluations.
        expr: |
          sum by (app, instance) (rate(prometheus_rule_evaluations_total{app="thanos-ruler"}[5m])) <= 0
            and
          sum by (app, instance) (thanos_rule_loaded_rules{app="thanos-ruler"}) > 0
        for: 5m
        labels:
          severity: critical
    - name: thanos-store
      rules:
      - alert: ThanosStoreGrpcErrorRate
        annotations:
          description: Thanos Store {{$labels.instance}} is failing to handle {{$value | humanize}}%
            of requests.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosstoregrpcerrorrate
          summary: Thanos Store is failing to handle qrpcd requests.
        expr: |
          (
            sum by (app) (rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss|DeadlineExceeded", app="thanos-store-gateway"}[5m]))
          /
            sum by (app) (rate(grpc_server_started_total{app="thanos-store-gateway"}[5m]))
          * 100 > 5
          )
        for: 5m
        labels:
          severity: warning
      - alert: ThanosStoreSeriesGateLatencyHigh
        annotations:
          description: Thanos Store {{$labels.instance}} has a 99th percentile latency of {{$value}}
            seconds for store series gate requests.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosstoreseriesgatelatencyhigh
          summary: Thanos Store has high latency for store series gate requests.
        expr: |
          (
            histogram_quantile(0.99, sum by (app, le) (rate(thanos_bucket_store_series_gate_duration_seconds_bucket{app="thanos-store-gateway"}[5m]))) > 2
          and
            sum by (app) (rate(thanos_bucket_store_series_gate_duration_seconds_count{app="thanos-store-gateway"}[5m])) > 0
          )
        for: 10m
        labels:
          severity: warning
      - alert: ThanosStoreBucketHighOperationFailures
        annotations:
          description: Thanos Store {{$labels.instance}} Bucket is failing to execute {{$value
            | humanize}}% of operations.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosstorebuckethighoperationfailures
          summary: Thanos Store Bucket is failing to execute operations.
        expr: |
          (
            sum by (app) (rate(thanos_objstore_bucket_operation_failures_total{app="thanos-store-gateway"}[5m]))
          /
            sum by (app) (rate(thanos_objstore_bucket_operations_total{app="thanos-store-gateway"}[5m]))
          * 100 > 5
          )
        for: 15m
        labels:
          severity: warning
      - alert: ThanosStoreObjstoreOperationLatencyHigh
        annotations:
          description: Thanos Store {{$labels.instance}} Bucket has a 99th percentile latency
            of {{$value}} seconds for the bucket operations.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosstoreobjstoreoperationlatencyhigh
          summary: Thanos Store is having high latency for bucket operations.
        expr: |
          (
            histogram_quantile(0.99, sum by (app, le) (rate(thanos_objstore_bucket_operation_duration_seconds_bucket{app="thanos-store-gateway"}[5m]))) > 2
          and
            sum by (app) (rate(thanos_objstore_bucket_operation_duration_seconds_count{app="thanos-store-gateway"}[5m])) > 0
          )
        for: 10m
        labels:
          severity: warning
    - name: thanos-sidecar
      rules:
      - alert: ThanosSidecarPrometheusDown
        annotations:
          description: Thanos Sidecar {{$labels.instance}} cannot connect to Prometheus.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanossidecarprometheusdown
          summary: Thanos Sidecar cannot connect to Prometheus
        expr: |
          thanos_sidecar_prometheus_up{thanos="sidecar"} == 0
        for: 5m
        labels:
          severity: critical
      - alert: ThanosSidecarBucketOperationsFailed
        annotations:
          description: Thanos Sidecar {{$labels.instance}} bucket operations are failing
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanossidecarbucketoperationsfailed
          summary: Thanos Sidecar bucket operations are failing
        expr: |
          sum by (thanos, instance) (rate(thanos_objstore_bucket_operation_failures_total{thanos="sidecar"}[5m])) > 0
        for: 5m
        labels:
          severity: critical
      - alert: ThanosSidecarUnhealthy
        annotations:
          description: Thanos Sidecar {{$labels.instance}} is unhealthy for more than {{$value}}
            seconds.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanossidecarunhealthy
          summary: Thanos Sidecar is unhealthy.
        expr: |
          time() - max by (thanos, instance) (timestamp(thanos_sidecar_last_heartbeat_success_time_seconds{thanos="sidecar"})) >= 240
        labels:
          severity: critical
    - name: thanos-query
      rules:
      - alert: ThanosQueryHttpRequestQueryErrorRateHigh
        annotations:
          description: Thanos Query {{$labels.instance}} is failing to handle {{$value | humanize}}%
            of "query" requests.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosqueryhttprequestqueryerrorratehigh
          summary: Thanos Query is failing to handle requests.
        expr: |
          (
            sum by (app) (rate(http_requests_total{code=~"5..", app="thanos-querier", handler="query"}[5m]))
          /
            sum by (app) (rate(http_requests_total{app="thanos-querier", handler="query"}[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: critical
      - alert: ThanosQueryHttpRequestQueryRangeErrorRateHigh
        annotations:
          description: Thanos Query {{$labels.instance}} is failing to handle {{$value | humanize}}%
            of "query_range" requests.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosqueryhttprequestqueryrangeerrorratehigh
          summary: Thanos Query is failing to handle requests.
        expr: |
          (
            sum by (app) (rate(http_requests_total{code=~"5..", app="thanos-querier", handler="query_range"}[5m]))
          /
            sum by (app) (rate(http_requests_total{app="thanos-querier", handler="query_range"}[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: critical
      - alert: ThanosQueryGrpcServerErrorRate
        annotations:
          description: Thanos Query {{$labels.instance}} is failing to handle {{$value | humanize}}%
            of requests.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosquerygrpcservererrorrate
          summary: Thanos Query is failing to handle requests.
        expr: |
          (
            sum by (app) (rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss|DeadlineExceeded", app="thanos-querier"}[5m]))
          /
            sum by (app) (rate(grpc_server_started_total{app="thanos-querier"}[5m]))
          * 100 > 5
          )
        for: 5m
        labels:
          severity: warning
      - alert: ThanosQueryGrpcClientErrorRate
        annotations:
          description: Thanos Query {{$labels.instance}} is failing to send {{$value | humanize}}%
            of requests.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosquerygrpcclienterrorrate
          summary: Thanos Query is failing to send requests.
        expr: |
          (
            sum by (app) (rate(grpc_client_handled_total{grpc_code!="OK", app="thanos-querier"}[5m]))
          /
            sum by (app) (rate(grpc_client_started_total{app="thanos-querier"}[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
      - alert: ThanosQueryHighDNSFailures
        annotations:
          description: Thanos Query {{$labels.instance}} have {{$value | humanize}}% of failing
            DNS queries for store endpoints.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosqueryhighdnsfailures
          summary: Thanos Query is having high number of DNS failures.
        expr: |
          (
            sum by (app) (rate(thanos_query_store_apis_dns_failures_total{app="thanos-querier"}[5m]))
          /
            sum by (app) (rate(thanos_query_store_apis_dns_lookups_total{app="thanos-querier"}[5m]))
          ) * 100 > 1
        for: 15m
        labels:
          severity: warning
      - alert: ThanosQueryInstantLatencyHigh
        annotations:
          description: Thanos Query {{$labels.instance}} has a 99th percentile latency of {{$value}}
            seconds for instant queries.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosqueryinstantlatencyhigh
          summary: Thanos Query has high latency for queries.
        expr: |
          (
            histogram_quantile(0.99, sum by (app, le) (rate(http_request_duration_seconds_bucket{app="thanos-querier", handler="query"}[5m]))) > 40
          and
            sum by (app) (rate(http_request_duration_seconds_bucket{app="thanos-querier", handler="query"}[5m])) > 0
          )
        for: 10m
        labels:
          severity: critical
      - alert: ThanosQueryRangeLatencyHigh
        annotations:
          description: Thanos Query {{$labels.app}} has a 99th percentile latency of {{$value}}
            seconds for range queries.
          runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosqueryrangelatencyhigh
          summary: Thanos Query has high latency for queries.
        expr: |
          (
            histogram_quantile(0.99, sum by (app, le) (rate(http_request_duration_seconds_bucket{app="thanos-querier", handler="query_range"}[5m]))) > 90
          and
            sum by (app) (rate(http_request_duration_seconds_count{app="thanos-querier", handler="query_range"}[5m])) > 0
          )
        for: 10m
        labels:
          severity: critical
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: thanos-ruler
  name: thanos-ruler
  annotations:
    prometheus.io/port: "10902"
    prometheus.io/scrape: "true"
spec:
  replicas: 3
  selector:
    matchLabels:
      app: thanos-ruler
  serviceName: thanos-ruler
  template:
    metadata:
      labels:
        app: thanos-ruler
        thanos-store-api: "true"
    spec:
      containers:
        - name: thanos
          image: thanosio/thanos:main-2021-04-15-2a999d25
          args:
            - rule
            - --log.level=debug
            - --data-dir=/data
            - --eval-interval=20s
            - --rule-file=/etc/thanos-ruler/*.rules.yaml
            - --alertmanagers.url=http://alertmanager:9093
            - --query=thanos-querier:9090
            - |
              --objstore.config=type: S3
              config:
                bucket: thanos-ruler
                endpoint: minio-hl-svc.minio:9000
                access_key: "$(AWS_ACCESS_KEY_ID)"
                secret_key: "$(AWS_SECRET_KEY)"
                insecure: true
            - --label=ruler_cluster="prometheus-ha"
            - --label=replica="$(POD_NAME)"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: s3-secret
                  key: accesskey
            - name: AWS_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-secret
                  key: secretkey
          ports:
            - name: http
              containerPort: 10902
            - name: grpc
              containerPort: 10901
          livenessProbe:
            httpGet:
              port: http
              path: /-/healthy
          readinessProbe:
            httpGet:
              port: http
              path: /-/ready
          volumeMounts:
            - mountPath: /etc/thanos-ruler
              name: config
      volumes:
        - configMap:
            name: thanos-ruler-rules
          name: config
---
# This service creates a srv record for querier to find about store-api's
apiVersion: v1
kind: Service
metadata:
  name: thanos-store-gateway
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: grpc
      port: 10901
      targetPort: grpc
  selector:
    thanos-store-api: "true"
---
# prometheus service for thanos-store
apiVersion: v1
kind: Service
metadata:
  name: thanos-store-gateway-prom
  labels:
    app: thanos-store-gateway
  annotations:
    prometheus.io/port: "10902"
    prometheus.io/scrape: "true"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 10902
      targetPort: http
  selector:
    app: thanos-store-gateway
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: thanos-compactor
  name: thanos-compactor
  annotations:
    prometheus.io/port: "10902"
    prometheus.io/scrape: "true"
spec:
  ports:
    - port: 10902
      protocol: TCP
      targetPort: http
      name: http
  selector:
    app: thanos-compactor
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  labels:
    app: prometheus
    app.kubernetes.io/component: core
  annotations:
    prometheus.io/port: "9090"
    prometheus.io/scrape: "true"
spec:
  type: NodePort
  ports:
    - port: 9090
      nodePort: 30830
      protocol: TCP
      name: webui
  selector:
    app: prometheus
    app.kubernetes.io/component: core
---
apiVersion: v1
kind: Service
metadata:
  name: thanos-sidecar
  labels:
    thanos: sidecar
  annotations:
    prometheus.io/port: "10902"
    prometheus.io/scrape: "true"
spec:
  type: ClusterIP
  ports:
    - port: 10902
      protocol: TCP
      name: http
  selector:
    thanos: sidecar
---
apiVersion: v1
kind: Service
metadata:
  name: thanos-querier
  labels:
    app: thanos-querier
  annotations:
    prometheus.io/port: "10902"
    prometheus.io/scrape: "true"
spec:
  type: NodePort
  ports:
  - port: 10902
    protocol: TCP
    targetPort: http
    nodePort: 30831
    name: http
  selector:
    app: thanos-querier
---
apiVersion: v1
kind: Service
metadata:
  name: thanos-ruler
  labels:
    app: thanos-ruler
  annotations:
    prometheus.io/port: "10902"
    prometheus.io/scrape: "true"
spec:
  type: NodePort
  ports:
    - port: 10902
      protocol: TCP
      targetPort: http
      nodePort: 30832
      name: http
  selector:
    app: thanos-ruler